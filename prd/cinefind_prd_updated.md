# Product Requirements Document (PRD)

## 1) Project Title

**CineFind** — Personalized Movie Search & Tagging Web App

## 2) Summary

Build a **Next.js** web app that lets users search a catalog of movies by title and filter results by a set of **admin-curated tags and categories**. Each authenticated user has their own account where they can:

- Assign tags (from the admin-defined list) to movies.  
- Assign categories (from the admin-defined list) to movies.  
- Add a short personal note (up to **400 characters**) per movie.  

All user tags, categories, and notes are private to the user. Authentication and data are managed by **Supabase**.  

## 3) Goals & Non-Goals

**Goals**  
- Fast movie title search and filtering by admin-defined categories/tags.  
- Admin-managed taxonomy of tags and categories.  
- Each user can personalize movies with tags, categories, and a short note.  
- Scalable to 50–100k movies.  

**Non-Goals**  
- No user-created tags or categories (must come from admin).  
- No public sharing of personal notes or labels.  
- No ratings or media streaming.  

## 4) Personas & Roles

- **Visitor (Unauthenticated):** Browse/search/filter movies.  
- **Signed-in User:** Assign tags, categories, and personal notes to movies.  
- **Admin:** CRUD on movies, tags, and categories. Bulk import, publish/unpublish.  

## 5) User Stories (v1)

1. As a visitor, I can search by movie title and filter by categories/tags.
2. As a signed-in user, I can select tags for a movie (from the admin list).
3. As a signed-in user, I can select a category for a movie (from the admin list).
4. As a signed-in user, I can add a personal note (up to 400 chars) for each movie.
5. As a signed-in user, I can view my tags, categories, and notes when revisiting a movie.
6. As an admin, I can create, edit, archive, and delete categories and tags.
7. As an admin, I can manage movies and assign categories.
8. As an admin, I can bulk import movies.

## 6) Functional Requirements

**Search & Filter**
- Full-text search on `movies.title`.
- Filter by categories and tags.
- Sorting and pagination.

**User Personalization**
- Each user can select zero or more tags per movie (from admin-curated tags).
- Each user can select one category per movie (from admin-curated categories).
- Each user can attach one personal note (<= 400 characters) per movie.
- User tags, categories, and notes are private to the user.

**Admin**
- CRUD for tags and categories.
- Movie CRUD and bulk import.

**Auth & Security**
- Supabase Auth.
- User-generated data tied to `auth.uid()`.
- RLS ensures users can only manage their own tags, categories, and notes.

## 7) Database Schema

```sql
-- Core movie catalog
drop table if exists public.movies cascade;
create table if not exists public.movies (
  id bigint generated by default as identity primary key,
  title text not null,
  description text,
  release_date date,
  poster_url text,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

-- Admin-curated tags
drop table if exists public.tags cascade;
create table if not exists public.tags (
  id bigint generated by default as identity primary key,
  name text not null unique,
  description text,
  created_at timestamptz not null default now()
);

-- Admin-curated categories
drop table if exists public.categories cascade;
create table if not exists public.categories (
  id bigint generated by default as identity primary key,
  name text not null unique,
  description text,
  created_at timestamptz not null default now()
);

-- Supabase provides `auth.users` as the base users table
-- Optional: custom user profile extension
drop table if exists public.profiles cascade;
create table if not exists public.profiles (
  id uuid primary key references auth.users(id) on delete cascade,
  display_name text,
  created_at timestamptz not null default now()
);

-- User-specific tagging
create table if not exists public.user_movie_tags (
  user_id uuid not null references auth.users(id) on delete cascade,
  movie_id bigint not null references public.movies(id) on delete cascade,
  tag_id bigint not null references public.tags(id) on delete cascade,
  created_at timestamptz not null default now(),
  primary key (user_id, movie_id, tag_id)
);

-- User-specific categorization
create table if not exists public.user_movie_categories (
  user_id uuid not null references auth.users(id) on delete cascade,
  movie_id bigint not null references public.movies(id) on delete cascade,
  category_id bigint not null references public.categories(id) on delete cascade,
  created_at timestamptz not null default now(),
  primary key (user_id, movie_id)
);

-- User-specific notes
create table if not exists public.user_movie_notes (
  user_id uuid not null references auth.users(id) on delete cascade,
  movie_id bigint not null references public.movies(id) on delete cascade,
  note text check (char_length(note) <= 400),
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  primary key (user_id, movie_id)
);

-- RLS policies
alter table public.user_movie_tags enable row level security;
alter table public.user_movie_categories enable row level security;
alter table public.user_movie_notes enable row level security;

create policy "user_tags_self_access" on public.user_movie_tags
  for all using (auth.uid() = user_id) with check (auth.uid() = user_id);

create policy "user_categories_self_access" on public.user_movie_categories
  for all using (auth.uid() = user_id) with check (auth.uid() = user_id);

create policy "user_notes_self_access" on public.user_movie_notes
  for all using (auth.uid() = user_id) with check (auth.uid() = user_id);
```

## 8) API Endpoints

- `GET /api/user/tags?movieId=123` → return tags selected by the current user.
- `POST /api/user/tags` → add/remove tags for a movie.
- `GET /api/user/category?movieId=123` → return category for current user.
- `POST /api/user/category` → upsert category for a movie.
- `GET /api/user/notes?movieId=123` → return note.
- `POST /api/user/notes` → upsert note (<= 400 chars).

## 9) UI Requirements

- **Movie Detail Page**
  - Show admin categories and global tags.
  - Authenticated users see a **tag picker** (multi-select).
  - Authenticated users see a **category selector** (single-select).
  - Authenticated users see a **note input** (textarea, 400 char max).

- **User State**
  - Tags, category, and note saved are private and visible only to the user.

## 10) Implementation Guide

- Phase 1: Core movie search, admin CRUD for movies, tags, categories.
- Phase 2: Add user-specific tables (tags, categories, notes) + RLS.
- Phase 3: Build API endpoints for user personalization.
- Phase 4: Update `/movies/:id` page with personalization UI components.
  - **Tag Picker Component**: Multi-select dropdown or chips.
  - **Category Selector Component**: Single-select dropdown.
  - **Note Editor Component**: Textarea with character counter.
- Phase 5: Client → API integration with optimistic updates.
- Phase 6: Validation with Zod + success/error toasts.

## 11) Acceptance Criteria

- A signed-in user can tag a movie with multiple tags from the admin list.
- A signed-in user can assign one category to a movie.
- A signed-in user can add a note (<= 400 chars) for a movie.
- All personalizations persist in Supabase and are private per user.
- Visitors can only view global categories/tags (not user-specific data).
- Admin-curated tags and categories remain global for filtering.
